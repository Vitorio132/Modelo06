<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sistema de Presença - IACAS</title>

  <style>
    body {
        background: linear-gradient(120deg, #f0f4f8, #d9e2ec);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
    }

    .container {
        max-width: 700px;
        margin: 50px auto;
        background: #ffffff;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }

    h2 {
        text-align: center;
        color: #333;
    }

    input, select, button {
        width: 100%;
        margin: 8px 0;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
    }

    button {
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    button:hover {
        background-color: #45a049;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    table th, table td {
        padding: 10px;
        text-align: center;
        border-bottom: 1px solid #ddd;
    }

    table th {
        background-color: #f7fafc;
        color: #555;
    }

    tr:hover {
        background-color: #f1f1f1;
    }

    .action-buttons button {
        margin-top: 10px;
    }
  </style>
</head>
<body>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <!-- Exportar Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<div id="login" class="container">
    <h2>Login do Professor</h2>
    <input type="text" id="username" placeholder="Usuário">
    <input type="password" id="password" placeholder="Senha">
    <button onclick="login()">Entrar</button>
</div>

<div id="selection" class="container" style="display:none;">
    <h2>Selecionar Escola e Turma</h2>
    <select id="escola" onchange="loadTurmas()">
        <option value="">Selecione a escola</option>
        <option value="CMEI Padre Luís Ruas">CMEI Padre Luís Ruas</option>
        <option value="Escola Municipal Nova Vida">Escola Municipal Nova Vida</option>
        <option value="Escola Estadual Santo Antônio">Escola Estadual Santo Antônio</option>
        <option value="Adolescentes - Vila da Felicidade">Adolescentes - Vila da Felicidade</option>
        <option value="Crianças - Vila da Felicidade">Crianças - Vila da Felicidade</option>
        <option value="Escola Estadual Liberalina Weil">Escola Estadual Liberalina Weil</option>
    </select>

    <select id="turma">
        <option value="">Selecione a turma</option>
    </select>

    <label>Data da chamada:</label>
    <input type="date" id="dataChamada">
    <button onclick="abrirChamada()">Abrir Chamada</button>
    <button onclick="verHistoricoMensal()">Ver Histórico Mensal</button>
    <button onclick="verTabelaMensalPorAluno()">Ver Tabela Completa de Alunos (Mês)</button>
</div>

<div id="chamada" class="container" style="display:none;">
    <h2>Chamada - <span id="escolaSelecionada"></span> / <span id="turmaSelecionada"></span></h2>

    <table>
        <thead>
        <tr>
            <th>Nome</th>
            <th>Presente</th>
            <th>Falta</th>
            <th>Ausente Justificado</th>
        </tr>
        </thead>
        <tbody id="tabelaAlunos"></tbody>
    </table>

    <div class="action-buttons">
        <button onclick="salvarChamada()">Salvar Chamada</button>
        <button onclick="exportarExcel()">Exportar para Excel</button>
        <button onclick="voltarParaSelecao()">Voltar</button>
    </div>
</div>

<div id="historicoMensal" class="container" style="display:none;">
    <h2>Histórico Mensal - <span id="escolaHistorico"></span> / <span id="turmaHistorico"></span></h2>
    <ul id="listaDatasMensal"></ul>
    <button onclick="exportarHistoricoMensal()">Exportar Histórico para Excel</button>
    <button onclick="voltarParaSelecao()">Voltar</button>
</div>

<div id="historicoAlunosMensal" class="container" style="display:none;">
    <h2>Tabela de Presença por Aluno - <span id="escolaTabela"></span> / <span id="turmaTabela"></span></h2>
    <div style="overflow-x:auto;">
        <table id="tabelaMensalPorAluno">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>
    <button onclick="exportarTabelaMensalPorAluno()">Exportar Tabela para Excel</button>
    <button onclick="voltarParaSelecao()">Voltar</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBwBiziQg4q9jOP0vT9Vg11j1yVzoX72gI",
    authDomain: "frequencia-escolas-iacas.firebaseapp.com",
    databaseURL: "https://frequencia-escolas-iacas-default-rtdb.firebaseio.com",
    projectId: "frequencia-escolas-iacas",
    storageBucket: "frequencia-escolas-iacas.appspot.com",
    messagingSenderId: "259315364059",
    appId: "1:259315364059:web:ddc66a60f18c563cc41cfe"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const professores = {
    "Izys": "iacas1234",
    "Vitorio": "iacas123",
    "Nayara": "nayara",
    "Karina": "8770220"
  };

  const turmasPorEscola = {
    "CMEI Padre Luís Ruas": ["2° P-B", "2° P-G", "2° P-J", "1° P-F"],
    "Escola Municipal Nova Vida": ["Turma 1"],
    "Escola Estadual Santo Antônio": ["Matutino"],
    "Adolescentes - Vila da Felicidade": ["Matutino", "Vespertino"],
    "Crianças - Vila da Felicidade": ["Turma 3 (Vespertino 1)", "Turma 4 (Vespertino 2)"],
    "Escola Estadual Liberalina Weil": ["7° Ano 01", "7° Ano 02", "8° Ano 01"]
  };

  let alunos = [];
  let escolaAtual = "";
  let turmaAtual = "";

  function login() {
    const user = document.getElementById('username').value;
    const pass = document.getElementById('password').value;
    if (professores[user] && professores[user] === pass) {
      document.getElementById('login').style.display = 'none';
      document.getElementById('selection').style.display = 'block';
    } else {
      alert("Login inválido!");
    }
  }

  function loadTurmas() {
    const escola = document.getElementById('escola').value;
    const turmaSelect = document.getElementById('turma');
    turmaSelect.innerHTML = '<option value="">Selecione a turma</option>';
    if (turmasPorEscola[escola]) {
      turmasPorEscola[escola].forEach(turma => {
        const opt = document.createElement('option');
        opt.value = turma;
        opt.innerText = turma;
        turmaSelect.appendChild(opt);
      });
    }
  }

  function gerarAlunosFixos() {
    const lista = [];
    for (let i = 1; i <= 35; i++) {
      lista.push({
        nome: `Aluno ${i}`,
        presente: false,
        falta: false,
        ausente: false
      });
    }
    return lista;
  }

  function abrirChamada() {
    escolaAtual = document.getElementById('escola').value;
    turmaAtual = document.getElementById('turma').value;
    const dataSelecionada = document.getElementById('dataChamada').value;

    if (!escolaAtual || !turmaAtual || !dataSelecionada) {
      alert("Selecione escola, turma e data!");
      return;
    }

    document.getElementById('selection').style.display = 'none';
    document.getElementById('chamada').style.display = 'block';
    document.getElementById('escolaSelecionada').innerText = escolaAtual;
    document.getElementById('turmaSelecionada').innerText = turmaAtual;

    const ref = db.ref(`chamada/${escolaAtual}/${turmaAtual}/${dataSelecionada}`);

    ref.once("value").then(snapshot => {
      if (snapshot.exists()) {
        alunos = snapshot.val();
      } else {
        alunos = gerarAlunosFixos();
        ref.set(alunos);
      }
      renderTabela();
    });

    ref.on("value", snapshot => {
      if (snapshot.exists()) {
        alunos = snapshot.val();
        renderTabela();
      }
    });
  }

  function renderTabela() {
    const tbody = document.getElementById('tabelaAlunos');
    tbody.innerHTML = '';
    alunos.forEach((aluno, index) => {
      tbody.innerHTML += `
        <tr>
          <td>${aluno.nome}</td>
          <td><input type="checkbox" onchange="marcar(${index}, 'presente')" ${aluno.presente ? 'checked' : ''}></td>
          <td><input type="checkbox" onchange="marcar(${index}, 'falta')" ${aluno.falta ? 'checked' : ''}></td>
          <td><input type="checkbox" onchange="marcar(${index}, 'ausente')" ${aluno.ausente ? 'checked' : ''}></td>
        </tr>
      `;
    });
  }

  function marcar(index, tipo) {
    alunos.forEach((aluno, i) => {
      if (i === index) {
        aluno.presente = (tipo === 'presente') ? !aluno.presente : false;
        aluno.falta = (tipo === 'falta') ? !aluno.falta : false;
        aluno.ausente = (tipo === 'ausente') ? !aluno.ausente : false;
      }
    });
    renderTabela();
  }

  function salvarChamada() {
    const dataSelecionada = document.getElementById('dataChamada').value;
    if (!dataSelecionada) {
      alert("Selecione uma data para salvar a chamada.");
      return;
    }
    const ref = db.ref(`chamada/${escolaAtual}/${turmaAtual}/${dataSelecionada}`);
    ref.set(alunos).then(() => alert("Chamada salva com sucesso!"));
  }

  function voltarParaSelecao() {
    document.getElementById('selection').style.display = 'block';
    document.getElementById('chamada').style.display = 'none';
    document.getElementById('historicoMensal').style.display = 'none';
    document.getElementById('historicoAlunosMensal').style.display = 'none';
  }

  function exportarExcel() {
    const dataSelecionada = document.getElementById('dataChamada').value || 'sem-data';
    const escola = escolaAtual || 'escola';
    const turma = turmaAtual || 'turma';
    const tabela = document.createElement('table');
    let html = '<tr><th>Nome</th><th>Presente</th><th>Falta</th><th>Ausente Justificado</th></tr>';
    alunos.forEach(a => {
      html += `<tr>
        <td>${a.nome}</td>
        <td>${a.presente ? 'X' : ''}</td>
        <td>${a.falta ? 'X' : ''}</td>
        <td>${a.ausente ? 'X' : ''}</td>
      </tr>`;
    });
    tabela.innerHTML = html;
    const ws = XLSX.utils.table_to_sheet(tabela);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Chamada");
    XLSX.writeFile(wb, `Chamada_${escola}_${turma}_${dataSelecionada}.xlsx`);
  }

  function verHistoricoMensal() {
    const escola = document.getElementById('escola').value;
    const turma = document.getElementById('turma').value;
    if (!escola || !turma) {
      alert("Selecione uma escola e uma turma!");
      return;
    }

    document.getElementById('selection').style.display = 'none';
    document.getElementById('historicoMensal').style.display = 'block';
    document.getElementById('escolaHistorico').innerText = escola;
    document.getElementById('turmaHistorico').innerText = turma;

    const ref = db.ref(`chamada/${escola}/${turma}`);
    const listaDatas = document.getElementById('listaDatasMensal');
    listaDatas.innerHTML = '';

    ref.once('value').then(snapshot => {
      if (!snapshot.exists()) {
        listaDatas.innerHTML = '<li>Nenhum dado encontrado.</li>';
        return;
      }
      snapshot.forEach(childSnap => {
        const data = childSnap.key;
        const li = document.createElement('li');
        li.textContent = data;
        listaDatas.appendChild(li);
      });
    });
  }

  // ----- NOVA FUNÇÃO PARA A TABELA MENSAL POR ALUNO ------

  function verTabelaMensalPorAluno() {
    const escola = document.getElementById('escola').value;
    const turma = document.getElementById('turma').value;
    if (!escola || !turma) {
      alert("Selecione uma escola e uma turma primeiro!");
      return;
    }

    document.getElementById('selection').style.display = 'none';
    document.getElementById('historicoAlunosMensal').style.display = 'block';
    document.getElementById('escolaTabela').innerText = escola;
    document.getElementById('turmaTabela').innerText = turma;

    const ref = db.ref(`chamada/${escola}/${turma}`);

    ref.once('value', snapshot => {
      if (!snapshot.exists()) {
        alert("Nenhuma chamada encontrada.");
        voltarParaSelecao();
        return;
      }

      const datas = [];
      const alunosPorNome = {};

      snapshot.forEach(dataSnap => {
        const data = dataSnap.key;
        datas.push(data);
        const alunosDaData = dataSnap.val();
        alunosDaData.forEach(aluno => {
          if (!alunosPorNome[aluno.nome]) {
            alunosPorNome[aluno.nome] = {};
          }
          alunosPorNome[aluno.nome][data] = aluno.presente ? 'P' : (aluno.falta ? 'F' : (aluno.ausente ? 'AJ' : ''));
        });
      });

      // Ordenar datas cronologicamente
      datas.sort();

      // Montar cabeçalho
      const thead = document.querySelector('#tabelaMensalPorAluno thead');
      thead.innerHTML = '<tr><th>Aluno</th>' + datas.map(d => `<th>${d}</th>`).join('') + '</tr>';

      // Montar corpo
      const tbody = document.querySelector('#tabelaMensalPorAluno tbody');
      tbody.innerHTML = '';
      Object.keys(alunosPorNome).forEach(nome => {
        let linha = `<tr><td>${nome}</td>`;
        datas.forEach(data => {
          const status = alunosPorNome[nome][data] || '';
          linha += `<td>${status}</td>`;
        });
        linha += '</tr>';
        tbody.innerHTML += linha;
      });
    });
  }

  function exportarTabelaMensalPorAluno() {
    const tabela = document.getElementById('tabelaMensalPorAluno');
    const ws = XLSX.utils.table_to_sheet(tabela);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Presença por Aluno");
    const escola = document.getElementById('escolaTabela').innerText;
    const turma = document.getElementById('turmaTabela').innerText;
    XLSX.writeFile(wb, `Tabela_Presenca_${escola}_${turma}.xlsx`);
  }
</script>
</body>
</html>
